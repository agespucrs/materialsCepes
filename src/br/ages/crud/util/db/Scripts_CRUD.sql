/**
 * Projeto CePESMaterials
 * Script de criação de banco de dados
 * Criação: 09/09/2015 - Cassio
 */


USE cepes_e;

CREATE TABLE TB_FUNCAO (
  ID_FUNCAO INT(11) NOT NULL AUTO_INCREMENT,
  NOME VARCHAR(255) NOT NULL,
  DESCRICAO VARCHAR(255) NOT NULL,
  PRIMARY KEY (ID_FUNCAO)
) ENGINE=INNODB DEFAULT CHARSET=UTF8;

CREATE TABLE TB_USUARIO (
  ID_USUARIO INT(11) NOT NULL AUTO_INCREMENT,
  USUARIO VARCHAR(30) NOT NULL,
  SENHA VARCHAR(8) NOT NULL,
  ADMINISTRADOR TINYINT(1) NOT NULL,
  MATRICULA VARCHAR(11) NOT NULL,
  NOME VARCHAR(120) NOT NULL,
  EMAIL VARCHAR(120) NOT NULL,
  DATA_CADASTRO DATETIME NOT NULL,
  ID_FUNCAO INT(11) NOT NULL,
  CPF VARCHAR(11) NOT NULL,
  PRIMARY KEY (`ID_USUARIO`),
  UNIQUE KEY `MATRICULA_UNIQUE` (`MATRICULA`),
  UNIQUE KEY `CPF_UNIQUE` (`CPF`),
  KEY `FK_TB_FUNCAO_IDX` (`ID_FUNCAO`),
  CONSTRAINT `FK_TB_FUNCAO` FOREIGN KEY (`ID_FUNCAO`) REFERENCES `TB_FUNCAO` (`ID_FUNCAO`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=INNODB DEFAULT CHARSET=UTF8;

CREATE TABLE TB_PROJETOS (
  ID_PROJETO INT(11) NOT NULL AUTO_INCREMENT,
  NOME_PROJETO VARCHAR(120) NOT NULL,
  PROGRAMA VARCHAR(120) NOT NULL,
  ORIGEM VARCHAR(120) NOT NULL,
  DATA_CADASTRO DATETIME NOT NULL,
  ID_CORDENADOR INT(11) NOT NULL,
  PRIMARY KEY (`ID_PROJETO`),
  KEY `FK_ID_CORDENADOR_IDX` (`ID_CORDENADOR`),
  CONSTRAINT `FK_ID_CORDENADOR` FOREIGN KEY (`ID_CORDENADOR`) REFERENCES `TB_USUARIO` (`ID_USUARIO`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=INNODB DEFAULT CHARSET=UTF8;


CREATE TABLE TB_IDIOMA (
  ID_IDIOMA INT(11) NOT NULL AUTO_INCREMENT,
  NOME VARCHAR(120) NOT NULL,
  PAIS VARCHAR(120) NOT NULL,
  PRIMARY KEY (`ID_IDIOMA`)
) ENGINE=INNODB DEFAULT CHARSET=UTF8;

   
CREATE TABLE TB_AUTOR (
  ID_AUTOR INT(11) NOT NULL AUTO_INCREMENT,
  NOME VARCHAR(60) NOT NULL,
  SOBRENOME VARCHAR(60) NOT NULL,
  PRIMARY KEY (ID_AUTOR)
) ENGINE=INNODB DEFAULT CHARSET=UTF8;

CREATE TABLE TB_EDITORA (
  ID_EDITORA INT(11) NOT NULL AUTO_INCREMENT,
  NOME VARCHAR(255) NOT NULL,
  PRIMARY KEY (ID_EDITORA)
) ENGINE=INNODB DEFAULT CHARSET=UTF8;

CREATE TABLE TB_LIVRO (
  ID_LIVRO INT(11) NOT NULL AUTO_INCREMENT,
  TITULO VARCHAR(120) NOT NULL,
  SUBTITULO VARCHAR(120) NOT NULL,
  DATA_CADASTRO DATETIME DEFAULT NULL,
  PRECO FLOAT NOT NULL DEFAULT '0',
  ID_IDIOMA INT(11) NOT NULL,
  CODIGO_ISBN VARCHAR(13) NOT NULL,
  EDICAO INT(3) NOT NULL,
  ANO INT(4) DEFAULT NULL,
  PAGINAS INT(4) DEFAULT NULL,
  VIDEO TINYINT(1) NOT NULL DEFAULT '0',
  CD_DVD TINYINT(1) NOT NULL DEFAULT '0',
  E_BOOK TINYINT(1) NOT NULL DEFAULT '0',
  BROCHURA TINYINT(1) NOT NULL DEFAULT '0',
  DESCRICAO TEXT,
  ID_EDITORA INT(11) NOT NULL,
  EXCLUIDO TINYINT(1) NOT NULL DEFAULT '0',
  REVISTA TINYINT(1) NOT NULL DEFAULT '0',
  EXPIRAL TINYINT(1) NOT NULL DEFAULT '0',
  DURA TINYINT(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (ID_LIVRO),
  UNIQUE KEY CODISBN_UNIQUE (CODIGO_ISBN),
  KEY FK_TB_IDIOMA_IDX (ID_IDIOMA),
  KEY FK_TB_EDITORA_IDX (ID_EDITORA),
  CONSTRAINT FK_TB_EDITORA FOREIGN KEY (ID_EDITORA) REFERENCES TB_EDITORA (ID_EDITORA) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT FK_TB_IDIOMA FOREIGN KEY (ID_IDIOMA) REFERENCES TB_IDIOMA (ID_IDIOMA) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=INNODB AUTO_INCREMENT=3 DEFAULT CHARSET=UTF8;

CREATE TABLE TB_LIVRO_COPIA (
  ID_COPIA INT(11) NOT NULL AUTO_INCREMENT,
  FK_ID_LIVRO INT(11) NOT NULL,
  CODIGO VARCHAR(13) NOT NULL,
  EXCLUIDO TINYINT(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (ID_COPIA),
  UNIQUE KEY ID_COPIA_UNIQUE (ID_COPIA),
  UNIQUE KEY CODIGO_UNIQUE (CODIGO),
  KEY FK_ID_LIVRO_IDX (FK_ID_LIVRO),
  CONSTRAINT FK_ID_LIVRO FOREIGN KEY (FK_ID_LIVRO) REFERENCES TB_LIVRO (ID_LIVRO) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=INNODB AUTO_INCREMENT=8 DEFAULT CHARSET=UTF8;

CREATE TABLE TB_LIVRO_AUTOR (
  ID_LIVRO INT(11) NOT NULL,
  ID_AUTOR INT(11) NOT NULL,
  KEY FK_LIVRO_IDX (ID_LIVRO),
  KEY FK_AUTOR (ID_AUTOR),
  CONSTRAINT FK_AUTOR FOREIGN KEY (ID_AUTOR) REFERENCES TB_AUTOR (ID_AUTOR) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT FK_LIVRO FOREIGN KEY (ID_LIVRO) REFERENCES TB_LIVRO (ID_LIVRO) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=INNODB DEFAULT CHARSET=UTF8;

CREATE TABLE TB_MARCA (
  ID_MARCA INT(11) NOT NULL AUTO_INCREMENT,
  NOME VARCHAR(255) NOT NULL,
  PRIMARY KEY (ID_MARCA)
  ) ENGINE=INNODB DEFAULT CHARSET=UTF8;

CREATE TABLE TB_EQUIPAMENTOS (
  ID_EQUIPAMENTO INT(11) NOT NULL AUTO_INCREMENT,
  N_PATRIMONIO INT(13) NOT NULL,
  STATUS TINYINT(1) NOT NULL,
  MODELO VARCHAR(120) DEFAULT NULL,
  VALOR_AQUISICAO DECIMAL(9,2) DEFAULT NULL,
  DATA_CADASTRO DATETIME NOT NULL,
  OBSERVACAO TEXT,
  ID_MARCA INT(11) NOT NULL,
  ID_PROJETO INT(11) NOT NULL,
  PRIMARY KEY (`ID_EQUIPAMENTO`),
  UNIQUE KEY `N_PATRIMONIO_UNIQUE` (`N_PATRIMONIO`),
  KEY `FK_ID_MARCA_IDX` (`ID_MARCA`),
  CONSTRAINT `FK_ID_MARCA` FOREIGN KEY (`ID_MARCA`) REFERENCES `TB_MARCA` (`ID_MARCA`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `FK_ID_PROJETO` FOREIGN KEY (`ID_PROJETO`) REFERENCES `TB_PROJETOS` (`ID_PROJETO`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=INNODB DEFAULT CHARSET=UTF8;

CREATE TABLE TB_COMPUTADOR (
  ID_COMPUTADOR INT(11) NOT NULL AUTO_INCREMENT,
  TIPO_COMPUTADOR VARCHAR(120) NOT NULL,
  ID_EQUIPAMENTO INT(11) NOT NULL,
  PRIMARY KEY (`ID_COMPUTADOR`),
  UNIQUE KEY `ID_EQUIPAMENTO_UNIQUE` (`ID_EQUIPAMENTO`),
  CONSTRAINT `FK_ID_EQUIPAMENTO` FOREIGN KEY (`ID_EQUIPAMENTO`) REFERENCES `TB_EQUIPAMENTOS` (`ID_EQUIPAMENTO`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=INNODB DEFAULT CHARSET=UTF8;


CREATE TABLE TB_MOBILE (
  ID_MOBILE INT(11) NOT NULL AUTO_INCREMENT,
  TIPO_MOBILE VARCHAR(120) NOT NULL,
  ID_EQUIPAMENTO INT(11) NOT NULL,
  PRIMARY KEY (`ID_MOBILE`),
  KEY `FK_ID_EQUIP_MOVEL_IDX` (`ID_EQUIPAMENTO`),
  CONSTRAINT `FK_ID_EQUIP_MOVEL` FOREIGN KEY (`ID_EQUIPAMENTO`) REFERENCES `TB_EQUIPAMENTOS` (`ID_EQUIPAMENTO`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=INNODB DEFAULT CHARSET=UTF8;

CREATE TABLE TB_PERIFERICO (
  ID_PERIFERICO INT(11) NOT NULL AUTO_INCREMENT,
  TIPO_PERIFERICO VARCHAR(120) NOT NULL,
  ID_EQUIPAMENTO INT(11) NOT NULL,
  PRIMARY KEY (`ID_PERIFERICO`),
  KEY `FK_ID_EQUIPAMENTO_IDX` (`ID_EQUIPAMENTO`),
  CONSTRAINT `FK_ID_EQUIP_PERI` FOREIGN KEY (`ID_EQUIPAMENTO`) REFERENCES `TB_EQUIPAMENTOS` (`ID_EQUIPAMENTO`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=INNODB DEFAULT CHARSET=UTF8;

ALTER TABLE TB_MARCA
ADD ATIVO VARCHAR(1) DEFAULT 'S' NOT NULL;

ALTER TABLE TB_EQUIPAMENTOS
ADD ATIVO VARCHAR(1) DEFAULT 'S' NOT NULL;

CREATE TABLE TB_TIPO (
ID_TIPO INT(11) NOT NULL AUTO_INCREMENT,
TIPO_EQUIPAMENTO VARCHAR(1) NOT NULL,
NOME VARCHAR(50) NOT NULL,
CONSTRAINT PK_ID_TIPO PRIMARY KEY (ID_TIPO)
) ENGINE=INNODB DEFAULT CHARSET=UTF8;   

ALTER TABLE TB_PERIFERICO CHANGE TIPO_PERIFERICO ID_TIPO INT(11) NOT NULL;

ALTER TABLE TB_COMPUTADOR CHANGE TIPO_COMPUTADOR ID_TIPO INT(11) NOT NULL;

ALTER TABLE TB_MOBILE CHANGE TIPO_MOBILE ID_TIPO INT(11) NOT NULL;

ALTER TABLE TB_PERIFERICO
ADD CONSTRAINT FK_TB_PERIFERICO_TB_TIPO
FOREIGN KEY (ID_TIPO)
REFERENCES TB_TIPO(ID_TIPO);

ALTER TABLE TB_MOBILE
ADD CONSTRAINT FK_TB_MOBILE_TB_TIPO
FOREIGN KEY (ID_TIPO)
REFERENCES TB_TIPO(ID_TIPO);

ALTER TABLE TB_COMPUTADOR
ADD CONSTRAINT FK_TB_COMPUTADOR_TB_TIPO
FOREIGN KEY (ID_TIPO)
REFERENCES TB_TIPO(ID_TIPO);

CREATE OR REPLACE VIEW VW_EQUIPAMENTOS AS
SELECT 
IF(ID_MOBILE IS NOT NULL, 'DISPOSITIVO MOVEL', 
  IF(ID_COMPUTADOR IS NOT NULL, 'COMPUTADOR', 
    IF(ID_PERIFERICO IS NOT NULL, 'PERIFERICO', 'ACESSORIO')
)) AS TIPO_EQUIPAMENTO,
--
IF(ID_COMPUTADOR IS NOT NULL, TIP1.NOME, 
  IF(ID_PERIFERICO IS NOT NULL, TIP2.NOME, 
    IF(ID_MOBILE IS NOT NULL, TIP3.NOME, "---")
)) AS SUB_TIPO,
--
EQUIP.ID_EQUIPAMENTO,
--
ID_COMPUTADOR, ID_PERIFERICO, ID_MOBILE, N_PATRIMONIO, EQUIP.DATA_CADASTRO, VALOR_AQUISICAO, MAR.NOME, MODELO, 
EQUIP.STATUS, OBSERVACAO, NOME_PROJETO
FROM 
TB_EQUIPAMENTOS AS EQUIP
LEFT JOIN TB_COMPUTADOR AS COMP ON COMP.ID_EQUIPAMENTO = EQUIP.ID_EQUIPAMENTO
LEFT JOIN TB_PERIFERICO AS PERIF ON PERIF.ID_EQUIPAMENTO = EQUIP.ID_EQUIPAMENTO
LEFT JOIN TB_MOBILE AS MOB ON MOB.ID_EQUIPAMENTO = EQUIP.ID_EQUIPAMENTO
LEFT JOIN TB_TIPO AS TIP1 ON TIP1.ID_TIPO = COMP.ID_TIPO
LEFT JOIN TB_TIPO AS TIP2 ON TIP2.ID_TIPO = PERIF.ID_TIPO
LEFT JOIN TB_TIPO AS TIP3 ON TIP3.ID_TIPO = MOB.ID_TIPO
INNER JOIN TB_MARCA AS MAR ON MAR.ID_MARCA = EQUIP.ID_MARCA
INNER JOIN TB_PROJETOS AS PROJ ON PROJ.ID_PROJETO = EQUIP.ID_PROJETO;

DELIMITER $$
CREATE OR REPLACE TRIGGER CHECK_TIPO_EQUIPAMENTO BEFORE INSERT ON TB_TIPO
FOR EACH ROW BEGIN
IF (NEW.TIPO_EQUIPAMENTO NOT IN ('A', 'C', 'M', 'P')) THEN
SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "ERROR ON FIELD TIPO_EQUIPAMENTO";
END IF;
END;
DELIMITER $$
DELIMITER ;

ALTER TABLE TB_TIPO ADD STATUS TINYINT(1) DEFAULT 1 NOT NULL;

ALTER TABLE TB_MARCA ADD STATUS TINYINT(1) DEFAULT 1 NOT NULL;

ALTER TABLE TB_MARCA DROP ATIVO;

ALTER TABLE TB_COMPUTADOR MODIFY COLUMN ID_COMPUTADOR INT(11) AUTO_INCREMENT;

CREATE TABLE TB_ACESSORIO (
  ID_ACESSORIO INT(11) NOT NULL AUTO_INCREMENT,
  ID_TIPO INT(11) NOT NULL,
  ID_EQUIPAMENTO INT(11) NOT NULL,
  QUANTIDADE INT(11) NOT NULL DEFAULT 0,
  CONSTRAINT PK_ID_TIPO PRIMARY KEY (ID_ACESSORIO),
  UNIQUE KEY ID_EQUIPAMENTO_UNIQUE (ID_EQUIPAMENTO),
  CONSTRAINT FK_ID_EQUIPAMENTO_ACESSORIO FOREIGN KEY (ID_EQUIPAMENTO) REFERENCES TB_EQUIPAMENTOS (ID_EQUIPAMENTO) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=INNODB DEFAULT CHARSET=UTF8;

ALTER TABLE TB_ACESSORIO
ADD CONSTRAINT FK_TB_ACESSORIO_TB_TIPO
FOREIGN KEY (ID_TIPO)
REFERENCES TB_TIPO(ID_TIPO);

CREATE TABLE `cepes_e`.`TB_USUARIO_PROJETO` (
  `ID_USUARIO` INT NOT NULL COMMENT '',
  `ID_PROJETO` INT NOT NULL COMMENT '',
  PRIMARY KEY (`ID_USUARIO`, `ID_PROJETO`)  COMMENT '',
  INDEX `FK_PROJETO_IDX` (`ID_PROJETO` ASC)  COMMENT '',
  CONSTRAINT `FK_USUARIO`
    FOREIGN KEY (`ID_USUARIO`)
    REFERENCES `cepes_e`.`TB_USUARIO` (`ID_USUARIO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `FK_PROJETO`
    FOREIGN KEY (`ID_PROJETO`)
    REFERENCES `cepes_e`.`TB_PROJETOS` (`ID_PROJETO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

ALTER TABLE TB_EQUIPAMENTOS
CHANGE N_PATRIMONIO N_PATRIMONIO INT(13) NULL;

ALTER TABLE `cepes_e`.`TB_USUARIO_PROJETO` 
ADD COLUMN `DATA_ALOCACAO` DATE NULL COMMENT '' AFTER `ID_PROJETO`;